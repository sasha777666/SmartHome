

Процедура ОбновитьСписокПроксиЕслиНетНиОдногоСПриоритетомТелеграмаВыше0(Оборудование = Неопределено) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	               |	ПроксиСервера_Приоритеты.ПроксиСервер КАК ПроксиСервер,
	               |	ПроксиСервера_Приоритеты.ПриоритетТелеграм КАК ПриоритетТелеграм
	               |ИЗ
	               |	РегистрСведений.ПроксиСервера_Приоритеты КАК ПроксиСервера_Приоритеты
	               |ГДЕ
	               |	ПроксиСервера_Приоритеты.ПриоритетТелеграм > 0";
	
	Если Запрос.Выполнить().Пустой() Тогда
		ДополнитьСписокПроксиСfreeproxylistИспользуяБесплатныйАПИ();
		ДополнитьСписокПроксиСspysИспользуяБесплатныйАПИ();		
	КонецЕсли;
	                                                                       	 
КонецПроцедуры


Функция ДополнитьСписокПроксиСfreeproxylistИспользуяБесплатныйАПИ() Экспорт
	
	//https://www.freeproxy-list.ru/api/proxy?anonymity=false&token=demo

	Сервер = "freeproxy-list.ru";
	Ресурс = "api/proxy?anonymity=false&token=demo"; 				
	
	Соединение = Новый HTTPСоединение(Сервер,,,,,,Новый ЗащищенноеСоединениеOpenSSL); 
	Запрос = Новый HTTPЗапрос(Ресурс);
    Запрос.Заголовки.Вставить("Connection", "keep-alive"); 
    Запрос.Заголовки.Вставить("Content-Type", "multipart/form-data;");       
    
	Ответ = Соединение.Получить(Запрос);
	СтрокаСПроксиСерверами = Ответ.ПолучитьТелоКакСтроку();
	
	Для Счетчик = 1 По СтрЧислоСтрок(СтрокаСПроксиСерверами) Цикл
   		ТекСтрока = СтрПолучитьСтроку(СтрокаСПроксиСерверами, Счетчик);
		ПозицияРазделителя = СтрНайти(ТекСтрока, ":"); 
		АдресПрокси = Лев(ТекСтрока, ПозицияРазделителя - 1); 
		НомерПорта = Число(Сред(ТекСтрока, ПозицияРазделителя + 1));
		 
		Если НомерПорта = 80 или НомерПорта = 8080 Тогда 
			
			ЗапросПрокси = Новый Запрос();
			ЗапросПрокси.Текст = "ВЫБРАТЬ
			                     |	ПроксиСервера.Ссылка КАК Ссылка
			                     |ИЗ
			                     |	Справочник.ПроксиСервера КАК ПроксиСервера
			                     |ГДЕ
			                     |	ПроксиСервера.АдресПроксиСервера = &АдресПроксиСервера
			                     |	И ПроксиСервера.ПортПроксиСервера = &ПортПроксиСервера";
			ЗапросПрокси.УстановитьПараметр("АдресПроксиСервера", АдресПрокси);
			ЗапросПрокси.УстановитьПараметр("ПортПроксиСервера", НомерПорта);

			Если ЗапросПрокси.Выполнить().Пустой() Тогда // Добавим новый прокси в нашу базу
				НовыйПрокси = Справочники.ПроксиСервера.СоздатьЭлемент();
				НовыйПрокси.Наименование = АдресПрокси; 
				НовыйПрокси.АдресПроксиСервера = АдресПрокси;
				НовыйПрокси.ПортПроксиСервера = НомерПорта;
				НовыйПрокси.Протокол = "https";
				НовыйПрокси.МожноИспользовать = Истина;
				НовыйПрокси.Записать();	
				
				МенеджерЗаписи = РегистрыСведений.ПроксиСервера_Приоритеты.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.ПроксиСервер = НовыйПрокси.Ссылка;
				МенеджерЗаписи.ПриоритетТелеграм = 300;
				МенеджерЗаписи.Записать();
			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;
	
КонецФункции

Функция ДополнитьСписокПроксиСspysИспользуяБесплатныйАПИ() Экспорт
	
	//http://spys.me/proxy.txt

	Сервер = "spys.me";
	Ресурс = "proxy.txt"; 				
	
	Соединение = Новый HTTPСоединение(Сервер,,,,,,); 
	Запрос = Новый HTTPЗапрос(Ресурс);
    Запрос.Заголовки.Вставить("Connection", "keep-alive"); 
    Запрос.Заголовки.Вставить("Content-Type", "multipart/form-data;");       
    
	Ответ = Соединение.Получить(Запрос);
	СтрокаСПроксиСерверами = Ответ.ПолучитьТелоКакСтроку();
	
	Для Счетчик = 10 По СтрЧислоСтрок(СтрокаСПроксиСерверами) Цикл
   		ТекСтрока = СтрПолучитьСтроку(СтрокаСПроксиСерверами, Счетчик);   
		Если Не ЗначениеЗаполнено(ТекСтрока) Тогда 
			Прервать;
		КонецЕсли;
		ПозицияРазделителя = СтрНайти(ТекСтрока, ":");
		ПозицияПробела = СтрНайти(ТекСтрока, " ");
		АдресПрокси = Лев(ТекСтрока, ПозицияРазделителя - 1); 
		НомерПорта = Число(Сред(ТекСтрока, ПозицияРазделителя + 1, ПозицияПробела - ПозицияРазделителя));
		Страна = Сред(ТекСтрока, ПозицияПробела + 1, 2); 
		Если СтрНайти(ТекСтрока, "S") > 0 И СтрНайти(ТекСтрока, "H") > 0 Тогда 
			
			ЗапросПрокси = Новый Запрос();
			ЗапросПрокси.Текст = "ВЫБРАТЬ
			                     |	ПроксиСервера.Ссылка КАК Ссылка
			                     |ИЗ
			                     |	Справочник.ПроксиСервера КАК ПроксиСервера
			                     |ГДЕ
			                     |	ПроксиСервера.АдресПроксиСервера = &АдресПроксиСервера
			                     |	И ПроксиСервера.ПортПроксиСервера = &ПортПроксиСервера";
			ЗапросПрокси.УстановитьПараметр("АдресПроксиСервера", АдресПрокси);
			ЗапросПрокси.УстановитьПараметр("ПортПроксиСервера", НомерПорта);

			Если ЗапросПрокси.Выполнить().Пустой() Тогда // Добавим новый прокси в нашу базу
				НовыйПрокси = Справочники.ПроксиСервера.СоздатьЭлемент();
				НовыйПрокси.Наименование = АдресПрокси; 
				НовыйПрокси.АдресПроксиСервера = АдресПрокси;
				НовыйПрокси.ПортПроксиСервера = НомерПорта;
				НовыйПрокси.Протокол = "https";
				НовыйПрокси.МожноИспользовать = Истина;
				НовыйПрокси.Страна = Страна;
				НовыйПрокси.Записать();	
				
				МенеджерЗаписи = РегистрыСведений.ПроксиСервера_Приоритеты.СоздатьМенеджерЗаписи();
				МенеджерЗаписи.ПроксиСервер = НовыйПрокси.Ссылка;
				МенеджерЗаписи.ПриоритетТелеграм = 300;
				МенеджерЗаписи.Записать();

			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;
	
КонецФункции
